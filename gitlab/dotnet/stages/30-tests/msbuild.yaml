include:
  - remote: 'https://raw.githubusercontent.com/rios0rios0/pipelines/main/gitlab/dotnet/abstracts/msbuild.yaml'

test:all:
  extends: '.msbuild'
  stage: 'tests'
  script:
    - nuget install OpenCover -Version 4.7.922 -OutputDirectory tools
    - nuget install ReportGenerator -Version 4.8.12 -OutputDirectory tools
    - tools\OpenCover.4.7.922\tools\OpenCover.Console.exe -register:user
        -target:"C:\Program Files (x86)\Microsoft Visual Studio\2019\TestAgent\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"
        -targetargs:"/InIsolation /Platform:x86 /Logger:trx /Framework:Framework40 /EnableCodeCoverage Tests\bin\Release\Tests.dll" -output:TestResults\coverage.xml
    - tools\ReportGenerator.4.8.12\tools\net47\ReportGenerator.exe -reports:TestResults\coverage.xml -targetdir:TestResults -reporttypes:HtmlInline_AzurePipelines
    - "[xml]$coverageData = Get-Content TestResults\\index.html"
    - $totalCoverage = ($coverageData.html.body.div.div.table.tbody.tr.Get(5).td - 0.001) / ($coverageData.html.body.div.div.table.tbody.tr.Get(7).td - 1) * 100
    - Write-Host "COVERAGE_PERCENT=$totalCoverage%"
  coverage: '/COVERAGE_PERCENT=([\d\.]+)%/'
  artifacts:
    when: 'always'
    paths:
      - 'TestResults'
